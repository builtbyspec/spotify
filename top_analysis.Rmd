---
title: "daily_top"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readr)
library(skimr)
library(lubridate)
library(tseries)
library(TTR)
library(corrplot)
library(broom)
```

```{r}
daily_top = read_csv("/Volumes/SD_Card/daily_top_acoustic.csv",col_names = TRUE)
```

Dropping NA's and a useless index column 

```{r}
daily_top <- daily_top %>%
               select(-X1) %>%
               drop_na()
```

## Correlation matrix

Correlation plot of all the numeric columns in the dataset. It makes sense that Streams and Positions have a strong negative correlation as the more streams an artist as on their song the more likely they will be higher on the charts.

```{r}
corrplot(as.matrix(daily_top %>%
                    filter(Region == "us") %>%
                    select_if(is.numeric) %>%
                      cor())) 
```
# Post Death Spotify

Lil Peep was a mostly underground artist before his death. However after his death many people started to listen to more of this music and he gained a lot of fame. Let's see if this is reflected on the spotify top charts.

```{r}
lil_peep <- data.frame("Event" = c("Death","Album","Falling Down"),"Date" = c(mdy("11-15-17"),mdy("11-9-18"),mdy("09-19-18")))
```

```{r}
lil_peep_time <- daily_top %>%
  mutate(Date = as.factor(Date)) %>%
  filter(Artist == "Lil Peep", Region == "us") %>%
  complete(Date) %>%
  group_by(Date) %>%
  summarize(max_pos = max(Position), avg_streams = mean(Streams)) %>%
  mutate(Date = ymd(Date))
```

```{r warning=FALSE}
ggplot(data = lil_peep_time, aes(Date, max_pos)) + geom_line() + geom_path(na.rm = TRUE) + 
    geom_vline(data = lil_peep, aes(xintercept = Date), alpha = 0.4) + 
    geom_text(data = lil_peep, mapping = aes(label = Event, y = 0), angle = -5, hjust = 0,
              vjust = 51, size = 2.5) + 
    scale_y_reverse(breaks = round(seq(0,200, by = 20)),
                    labels = c(1,20,40,60,80,100,120,140,160,180,200)) +
    ylab("Max Position") + xlab(element_blank()) + 
    ggtitle("Lil Peep's Position on Spotify Charts over time")

ggplot(data = lil_peep_time, aes(Date, avg_streams)) + geom_line() + geom_path(na.rm = TRUE) + 
    geom_vline(data = lil_peep, aes(xintercept = Date), alpha = 0.4) + 
    geom_text(data = lil_peep, mapping = aes(label = Event, y = 0), angle = -5, hjust = 1,
              size = 2.5) + 
    ylab("Average Streams") + xlab(element_blank()) + 
    ggtitle("Lil Peep's Streams on Spotify Charts over time")
```

```{r}
xxx_events <- data.frame("Event" = c("Death","SAD","Skins","17"),"Date" = c(mdy("06-18-18"),mdy("03-16-18"),mdy("12-7-18"),mdy("08-25-2017")))
```

```{r}
xxx <- daily_top %>%
  mutate(Date = as.factor(Date)) %>%
  filter(Artist == "XXXTENTACION", Region == "us") %>%
  complete(Date) %>%
  group_by(Date) %>%
  summarize(max_pos = max(Position), avg_streams = mean(Streams)) %>%
  mutate(Date = ymd(Date))

```


```{r warning=FALSE}
ggplot(data = xxx, aes(Date, max_pos)) + geom_line() + geom_path(na.rm = TRUE) + 
    geom_vline(data = xxx_events, aes(xintercept = Date), alpha = 0.4) + 
    geom_text(data = xxx_events, mapping = aes(label = Event, y = 0), angle = -5, hjust = 0,
              vjust = 51, size = 2.5) + 
    scale_y_reverse(breaks = round(seq(0,200, by = 20)),
                    labels = c(1,20,40,60,80,100,120,140,160,180,200)) +
    ylab("Max Position") + xlab(element_blank()) + 
    ggtitle("XXXtentacion's Position on Spotify Charts over time")

ggplot(data = xxx, aes(Date, avg_streams)) + geom_line() + geom_path(na.rm = TRUE) + 
    geom_vline(data = xxx_events, aes(xintercept = Date), alpha = 0.4) + 
    geom_text(data = xxx_events, mapping = aes(label = Event, y = 0), angle = -5, hjust = 1,
              size = 2.5) + 
    ylab("Average Streams") + xlab(element_blank()) + 
    ggtitle("XXXtentacion's Streams on Spotify Charts over time")
  
```
```{r}
daily_top %>%
  mutate(weekday = wday(Date,label = TRUE)) %>%
  group_by(weekday) %>%
  summarize(stream = mean(Streams)) %>%
  arrange(desc(stream))
```
```{r}
daily_top %>%
  mutate(weekday = wday(Date,label = TRUE)) %>%
  do(tidy(aov(Streams ~ weekday, data = .),type ="III"))
```

```{r}
top_20_us <- daily_top %>%
  filter(Region == "us") %>%
  count(Artist) %>%
  arrange(desc(n)) %>%
  top_n(20,n) %>%
  pull(Artist)

top_50_us <- daily_top %>%
  filter(Region == "us") %>%
  count(Artist) %>%
  arrange(desc(n)) %>%
  top_n(50,n) %>%
  pull(Artist)
```

```{r}
daily_top %>%
  filter(Artist %in% top_20_us) %>%
  count(Artist,Region) %>%
  replace_na(list(n = 0))  %>%
  mutate(Region = case_when(
    Region == "us" ~ "us",
    TRUE ~ "non_us"
        )) %>%
  group_by(Artist,Region) %>%
  summarize(times_on_chart = median(n)) %>%
  spread(Region, times_on_chart) %>%
  mutate(diff = non_us - us) %>%
  arrange(desc(diff))

```

```{r}
daily_top %>%
  count(Artist) %>%
  top_n(20,n) %>%
  mutate(Artist = fct_reorder(Artist,n)) %>%
  ggplot(aes(x=Artist,y=n)) + geom_col() + coord_flip() + ggtitle("Most apperances")
```
```{r}
daily_top %>%
  count(Artist,`Track Name`) %>%
  count(Artist) %>%
  arrange(desc(nn)) %>%
  mutate(Artist = fct_reorder(Artist,nn)) %>%
  top_n(20,nn) %>%
  ggplot(aes(x=Artist,y=nn, fill=Artist)) + geom_col() + coord_flip() + 
    ggtitle("Number of Songs on Daily Chart") + guides(fill=FALSE) + 
    ylab("Amount of Different Songs")
```

```{r}
daily_top %>%
  filter(Artist %in% top_20_us) %>%
  mutate(duration_sc = duration_ms/1000) %>%
  group_by(Artist, `Track Name`) %>%
  summarize(mean_duration = mean(duration_sc)) %>%
  group_by(Artist) %>%
  summarize(mean_duration = mean(mean_duration)) %>%
  mutate(Artist = fct_reorder(Artist,mean_duration)) %>%
  ggplot(aes(Artist,mean_duration,fill=Artist)) + geom_col() + coord_flip() + 
    guides(fill=FALSE) + ylab("Mean Duration of Songs on Top 100 (Seconds)") + 
    ggtitle("The Average Song Length of Top 20 US Artists")
  
```

```{r}
daily_top %>%
  count(time_signature)
```

```{r}
mean_streams <- daily_top %>%
  filter(Region == "us") %>%
  #filter(Date > ymd("2019-1-1")) %>%
  group_by(Date) %>%
  summarize(mean_streams = mean(Streams)) %>%
  pull(mean_streams)

adf.test(mean_streams, alternative = "stationary")

acf(mean_streams, lag.max=30) #

pacf(mean_streams, lag.max=30) # exceeds line so there is seasonality

SmoothedSines <- SMA(mean_streams, n=5) #specify averaging over 5 time points

plot(SmoothedSines,type="l")

#periodogram(Diff2TwoSinesGoingUpExponentially)
  #ggplot(aes(Date,mean_streams))+geom_line()
```
```{r}
daily_top %>%
  group_by(Region, `Track Name`, key) %>%
  group_by(Region, key) %>%
  tally() %>%
  drop_na() %>%
  group_by(Region) %>%
  filter(n %in% range(n)) %>%
  filter(Region %in% c('us','ca')) %>%
  mutate(key = as.character(key)) %>%
  ggplot(aes(key,n)) + geom_col(position = "dodge") + facet_wrap(~Region)


```

